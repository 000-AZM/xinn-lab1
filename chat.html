<!DOCTYPE html>
<html>
<head>
  <title>Chat - Xinn Lab</title>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="js/firebase-config.js"></script>
  <style>
    #chat-messages { border:1px solid #ccc; height:300px; overflow:auto; padding:10px; }
    #chat-input { width:80%; }
    #send-btn { width:18%; }
  </style>
</head>
<body>
  <nav>
    <a href="profile.html">Profile</a> |
    <a href="search.html">Search</a> |
    <a href="chat.html">Chat</a> |
    <a href="settings.html">Settings</a> |
    <a href="#" id="logout-btn">Logout</a>
  </nav>

  <h1>Chat</h1>
  <p>
    Chat with user ID: <input type="text" id="chat-user-id" placeholder="Enter friend user ID" />
    <button id="start-chat">Start Chat</button>
  </p>
  <div id="chat-messages"></div>
  <input id="chat-input" placeholder="Type a message..." />
  <button id="send-btn">Send</button>

  <script>
    const logoutBtn = document.getElementById('logout-btn');
    logoutBtn.onclick = () => auth.signOut().then(() => window.location.href = 'login.html');

    let currentChatId = null;
    let unsubscribe = null;

    auth.onAuthStateChanged(user => {
      if (!user) window.location.href = 'login.html';
    });

    function generateChatId(uid1, uid2) {
      return uid1 < uid2 ? uid1 + '_' + uid2 : uid2 + '_' + uid1;
    }

    document.getElementById('start-chat').onclick = () => {
      const friendId = document.getElementById('chat-user-id').value.trim();
      const user = auth.currentUser;
      if (!user) return;

      if (unsubscribe) unsubscribe(); // unsubscribe previous listener

      currentChatId = generateChatId(user.uid, friendId);

      const messagesDiv = document.getElementById('chat-messages');
      messagesDiv.innerHTML = 'Loading messages...';

      unsubscribe = db.collection('chats').doc(currentChatId)
        .collection('messages')
        .orderBy('timestamp')
        .onSnapshot(snapshot => {
          messagesDiv.innerHTML = '';
          snapshot.forEach(doc => {
            const msg = doc.data();
            const msgDiv = document.createElement('div');
            msgDiv.textContent = (msg.sender === user.uid ? 'Me: ' : 'Friend: ') + msg.text;
            messagesDiv.appendChild(msgDiv);
          });
          messagesDiv.scrollTop = messagesDiv.scrollHeight;
        });
    };

    document.getElementById('send-btn').onclick = () => {
      const user = auth.currentUser;
      if (!user || !currentChatId) {
        alert('Start a chat first!');
        return;
      }
      const input = document.getElementById('chat-input');
      const text = input.value.trim();
      if (!text) return;

      db.collection('chats').doc(currentChatId).collection('messages').add({
        sender: user.uid,
        text,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      });

      input.value = '';
    };
  </script>
</body>
</html>
