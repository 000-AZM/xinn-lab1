<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" /><meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Chat</title>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="js/firebase-config.js"></script>
  <style>#msgs{border:1px solid #ccc;height:300px;overflow:auto;padding:10px;margin:1rem 0}input{width:80%;}button{width:18%}</style>
</head>
<body>
  <nav>
    <a href="profile.html">Profile</a>|
    <a href="search.html">Search</a>|
    <a href="chat.html">Chat</a>|
    <a href="settings.html">Settings</a>|
    <a href="#" id="logout">Logout</a>
  </nav>
  <h2>Chat (enter friend's UID below)</h2>
  <input id="fid" placeholder="Friend User ID" /><button id="start">Start</button>
  <div id="msgs"></div>
  <input id="txt" placeholder="Type message" /><button id="send">Send</button>
  <script>
    document.getElementById('logout').onclick = ()=> auth.signOut().then(()=>location.href='login.html');
    let unsub, cid;
    auth.onAuthStateChanged(u=>{ if(!u) location.href='login.html'; });
    function gen(a,b){return a<b?a+'_'+b:b+'_'+a;}
    document.getElementById('start').onclick = ()=>{
      const fid = fid.value.trim();
      const me = auth.currentUser;
      if(!fid||!me) return alert('Enter friend ID');
      cid = gen(me.uid,fid);
      if(unsub) unsub();
      unsub = db.collection('chats').doc(cid).collection('messages').orderBy('timestamp').onSnapshot(s=>{
        msgs.innerHTML='';
        s.forEach(d=>{ const m=d.data(); const div=document.createElement('div');
          div.textContent=(m.sender===me.uid?'Me':'Friend')+': '+m.text;
          msgs.append(div);
        });
        msgs.scrollTop=msgs.scrollHeight;
      });
    }
    send.onclick = ()=>{
      const me = auth.currentUser;
      if(!me||!cid) return alert('Start a chat first');
      const t= txt.value.trim(); if(!t) return;
      db.collection('chats').doc(cid).collection('messages').add({sender:me.uid,text:t,timestamp:firebase.firestore.FieldValue.serverTimestamp()});
      txt.value='';
    }
  </script>
</body>
</html>
