<!DOCTYPE html>
<html lang="en"><head>‚Ä¶</head><body>
<nav>‚Ä¶logout‚Ä¶</nav>
<div class="‚Ä¶container‚Ä¶">
  <h2>Posts</h2>
  <textarea id="new-post" placeholder="What's new?"></textarea>
  <select id="visibility"><option value="public">Public</option><option value="private">Only Me</option></select>
  <button id="post-btn">Post</button>
  <div id="posts-area"></div>
</div>

<script>
  (async () => {
    if (! (await checkSystemUpdate())) return;
    redirectIfNotLoggedIn();
    document.getElementById("logout").onclick = logout;
    const db = firebase.firestore(), u = firebase.auth().currentUser;
    document.getElementById("post-btn").onclick = async () => {
      const content = document.getElementById("new-post").value.trim();
      if (!content) return;
      await db.collection("posts").add({
        uid: u.uid,
        content,
        visibility: document.getElementById("visibility").value,
        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
        likes: [],
        comments: []
      });
      loadPosts();
    };
    async function loadPosts() {
      const snaps = await db.collection("posts").orderBy("timestamp", "desc").get();
      const area = document.getElementById("posts-area");
      area.innerHTML = "";
      for (const doc of snaps.docs) {
        const p = doc.data();
        if (p.visibility === "private" && p.uid !== u.uid) continue;
        const udoc = await db.collection("users").doc(p.uid).get();
        const div = document.createElement("div");
        div.innerHTML = `
          <div><img src="${udoc.data().avatar||'‚Ä¶'}" style="width:30px;"/><strong>${udoc.data().username}</strong> ‚Ä¢ ${new Date(p.timestamp?.toDate()).toLocaleString()}</div>
          <p>${p.content}</p>
          <div>
            <span onclick="like('${doc.id}')">‚ù§Ô∏è ${p.likes.length}</span>
            <span onclick="toggleComent('${doc.id}')">üí¨</span>
          </div>
          <div id="c-${doc.id}" style="display:none;">
            <input placeholder="Comment..." onkeydown="if(event.key==='Enter') comment('${doc.id}', this)" />
            ${(p.comments||[]).map(c=>`<div>${c}</div>`).join('')}
          </div>
        `;
        area.appendChild(div);
      }
    }
    window.like = async (id) => { await db.collection("posts").doc(id).update({
        likes: firebase.firestore.FieldValue.arrayUnion(u.uid)
      }); loadPosts(); };
    window.toggleComent = id => {
      const e = document.getElementById(`c-${id}`);
      e.style.display = (e.style.display === "none") ? "block" : "none";
    };
    window.comment = async (id, input) => {
      const txt = input.value.trim();
      if (!txt) return;
      await db.collection("posts").doc(id).update({
        comments: firebase.firestore.FieldValue.arrayUnion(txt)
      });
      loadPosts();
    };
    loadPosts();
  })();
</script>
</body></html>
