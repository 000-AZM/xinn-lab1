<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" /><meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Profile</title>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="js/firebase-config.js"></script>
  <style>
    body{font-family:Arial;margin:20px}
    nav a{margin-right:10px;text-decoration:none}
    .section{margin-top:1rem}
    button{margin-left:5px}
  </style>
</head>
<body>
  <nav>
    <a href="profile.html">Profile</a>|
    <a href="search.html">Search</a>|
    <a href="chat.html">Chat</a>|
    <a href="settings.html">Settings</a>|
    <a href="#" id="logout">Logout</a>
  </nav>
  <div id="info" class="section"><h2>Profile</h2></div>
  <div id="requests" class="section"><h3>Friend Requests</h3></div>
  <div id="friends" class="section"><h3>Friends</h3></div>

  <script>
    document.getElementById('logout').onclick = () => auth.signOut().then(()=>location.href='login.html');
    auth.onAuthStateChanged(async u => {
      if (!u) return location.href='login.html';
      const doc = await db.collection('users').doc(u.uid).get();
      if (!doc.exists) return alert('User data missing');
      const data = doc.data();
      document.getElementById('info').innerHTML = `<p><strong>Username:</strong> ${data.username}</p><p><strong>Email:</strong> ${data.email}</p><p><strong>Bio:</strong> ${data.bio||'(empty)'}</p>`;
      document.getElementById('requests').innerHTML = '<h3>Friend Requests</h3>';
      for (let rid of data.friendRequestsReceived) {
        const rd = await db.collection('users').doc(rid).get();
        if (!rd.exists) continue;
        const rname = rd.data().username;
        const div = document.createElement('div');
        div.textContent = rname;
        const acc = document.createElement('button'); acc.textContent='Accept'; acc.onclick =()=>respond(u.uid,rid,true);
        const dec = document.createElement('button'); dec.textContent='Decline'; dec.onclick =()=>respond(u.uid,rid,false);
        div.append(acc,dec); document.getElementById('requests').append(div);
      }
      document.getElementById('friends').innerHTML = '<h3>Friends</h3>';
      for (let fid of data.friends) {
        const fd = await db.collection('users').doc(fid).get();
        if (!fd.exists) continue;
        const fdiv = document.createElement('div');
        fdiv.textContent = fd.data().username;
        document.getElementById('friends').append(fdiv);
      }
    });
    async function respond(myUid, otherUid, accept){
      const myRef = db.collection('users').doc(myUid), oRef = db.collection('users').doc(otherUid);
      await db.runTransaction(async tx =>{
        const myDoc = await tx.get(myRef), oDoc = await tx.get(oRef);
        if (!myDoc.exists||!oDoc.exists) return;
        const my = myDoc.data(), o = oDoc.data();
        my.friendRequestsReceived = my.friendRequestsReceived.filter(x=>x!==otherUid);
        o.friendRequestsSent = o.friendRequestsSent.filter(x=>x!==myUid);
        if (accept){ my.friends.push(otherUid); o.friends.push(myUid); }
        tx.update(myRef,my); tx.update(oRef,o);
      });
      location.reload();
    }
  </script>
</body>
</html>
